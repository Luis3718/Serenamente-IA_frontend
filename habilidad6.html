<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habilidad 5 Comunicacion que Conecta</title>
    <link rel="stylesheet" href="static/styles/habilidad.css">
</head>

<header>
    <div class="header-container">
        <div class="logo-container">
            <a href="index.html">
                <img src="static/imagenes/logo.jpeg" alt="Logo SerenaMente IA" class="logo">
            </a>
        </div>
        <button class="menu-toggle" aria-label="Toggle Menu">&#9776;</button>
        <nav class="submenu">
            <ul>
                <li><a href="actividades.html">Mis actividades</a></li>
                <li><a href="progreso.html">Mi progreso</a></li>
                <div class="user-menu">
                    <div id="user-avatar" class="avatar">US</div>
                    <div id="user-dropdown" class="dropdown-menu">
                        <a href="perfil.html">Ver perfil</a>
                        <a href="#" id="logout">Cerrar sesión</a>
                    </div>
                </div>                        
            </ul>
        </nav>
    </div>
</header>


<main>
    <div class="container">
        <h1>Habilidad 5: Comunicacion que Conecta</h1>
            <div style="display: flex; align-items: flex-start; gap: 20px;">
                <img src="static/imagenes/image6.jpg" alt="Descripción de la imagen" style="height: 100%; max-height: 300px; width: auto; object-fit: cover;">
                <div style="flex: 1;">
                    <p> ¡Hola! ¡Te doy la bienvenida a esta nueva habilidad, te felicito por
                        estar a punto de llegar a la recta final! Aprovecho para comentarte que, una vez finalizado el proceso, nos estaremos poniendo en contacto contigo para
                        conocer cómo te fue y dar seguimiento a tus avances.<br>
                       <br><strong>Objetivo:</strong> El desarrollar esta habilidad te facilitará el dejar de reaccionar automáticamente ante las situaciones y las dificultades, para empezar a responder con mayor
                       calma y claridad. Aprenderás a reconocer tus patrones habituales de respuesta, incluyendo tus comunicaciones con los demás.
                       <br><br>
                       ¿Alguna vez has reaccionado sin pensar y luego te arrepentiste? En esta habilidad vas a aprender a darte un momento antes de actuar, para que puedas
                       elegir una respuesta más consciente en tus relaciones con los demás. Así podrás reconocer cómo sueles reaccionar y empezar a cambiar la forma en que te
                       relacionas contigo mismo y con el mundo que te rodea.
                       </p> 
                    <div class="recuerda-box">
                        <img src="static/imagenes/recuerda.jpeg" alt="Koala recuerda" class="koala-img">
                        <p><strong>Recuerda:</strong> Practicar todos los días lo que hemos visto te ayudará a crear hábitos que mejoren tu salud mental. Cuando repites una actividad,
                            aprendes más y puedes notar cómo algo tan sencillo puede ayudarte a sentirte más tranquilo y en equilibrio. Así podrás elegir mejor cómo
                            responder en tus relaciones con los demás</p>
                    </div>
                </div>
            </div>
            <p>¡Y lo mejor de todo! Esta práctica también puede tener un efecto positivo en las personas que te rodean.
                <br>
                Para esto, revisa este memorama para revisar conceptos básicos que te ayudarán a comprender mejor las respuestas conscientes.</p>
                <div class="game-board" id="gameBoard"></div>
                <div class="win-message" id="winMessage">¡Felicidades, lo lograste!</div>

                <p>Ahora que ya viste cómo una respuesta más consciente puede influir en tu vida diaria y en tus
                relaciones, es más fácil que empieces a notar tus reacciones automáticas: lo que piensas, sientes y haces sin darte cuenta. Con ayuda de la atención plena,
                puedes aprender a darte un momento antes de actuar y así elegir cómo responder, en lugar de reaccionar por impulso. Esto también te ayuda a relacionarte
                mejor con otras personas, con más empatía y comprensión.<br>
                <strong> Vamos a iniciar</strong>
                </p>
   

            <div class="button-container">
                <button onclick="startExperience()">Sí, tengo todo preparado para iniciar</button>
                <button onclick="postponeExperience()">No, quisiera empezar después</button>
            </div>
            
            <div id="activities-menu">
                <div class="serenito">
                    <div class="speech-bubble">Selecciona la actividad para comenzar</div>
                    <img src="static/imagenes/serenito.png" alt="Serenito">
                </div>
                <div class="activities">
                    <!-- Actividad 1  -->
                    <div class="activity">
                        <div class="activity-card" id="activity1" onclick="unlockActivity(2)">
                            <p>1. Tejiendo Conexiones Conscientes </p>
                            <a href="actividad51.html">
                                <button> 
                                    <img src="static/imagenes/boton51.png" alt="Actividad 1">
                                </button>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Actividad 2 -->
                    <div class="activity">
                        <div class="activity-card disabled" id="activity2" onclick="unlockActivity(3)">
                            <p>2. La Montaña Interior en tus Vínculos </p>
                            <a href="actividad52.html">
                                <button disabled>
                                    <img src="static/imagenes/boton52.png" alt="Actividad 2">
                                </button>
                            </a>
                        </div>
                    </div>
            
                    <!-- Actividad 3  -->
                    <div class="activity">
                        <div class="activity-card disabled" id="activity3"onclick="unlockActivity(4)">
                            <p>3. Pausa y Elige tu Respuesta </p>
                            <a href="actividad53.html">
                                <button disabled>
                                    <img src="static/imagenes/boton53.png" alt="Actividad 3">
                                </button>
                            </a>
                        </div>
                    </div>
                    <!-- Actividad 4 -->
                    <div class="activity">
                        <div class="activity-card disabled" id="activity4">
                            <p>4.Presencia Consciente en tus Conversaciones</p>
                            <a href="actividad54.html">
                                <button disabled>
                                    <img src="static/imagenes/boton54.png" alt="Actividad 4">
                                </button>
                            </a>
                        </div>
                    </div>
        </div>
    </div>
</main>
<div class="social-bar">
    <a href="https://www.facebook.com/SerenaMenteUNAM?_rdc=1&_rdr#" target="_blank" class="social-icon">
        <img src="static/imagenes/Logo_facebook.png" alt="Facebook">
    </a>
    <a href="https://www.instagram.com/serenamente_app/?igshid=YTQwZjQ0NmI0OA%3D%3D" target="_blank" class="social-icon">
        <img src="static/imagenes/Logo_instagram.png" alt="Instagram">
    </a>
    <a href="https://www.youtube.com/@SerenaMente-xk7tm" target="_blank" class="social-icon">
        <img src="static/imagenes/Logo_youtube.png" alt="YouTube">
    </a>

</div>

<!--Banner con logos-->
<div class="banner-section">
    <div class="banner-logo">
        <img src="static/imagenes/LOGO.png" alt="Logo SerenaMente">
    </div>
    <div class="banner-text">
        <p>Cuenta con el respaldo y colaboración de investigadores e investigadoras de las siguientes instituciones.</p>
    </div>
    <div class="banner-logos">
        <a href="https://www.unam.mx">
            <img src="static/imagenes/Logo1.png" alt="Logo UNAM">
        </a>
        <a href="https://suayed.iztacala.unam.mx/">
            <img src="static/imagenes/Logo2.png" alt="Logo SUAYED">
        </a>
        <a href="https://labpsiit.iztacala.unam.mx/">
            <img src="static/imagenes/Logo3.png" alt="Logo LABPSITT">
        </a>
        <a href="https://www.ipn.mx/">
            <img src="static/imagenes/Logo4.png" alt="Logo IPN">
        </a>
        <a href="https://www.escom.ipn.mx/">
            <img src="static/imagenes/Logo5.png" alt="Logo ESCOM">
        </a>
    </div>
</div>

<!-- Footer -->
<footer>
    <div class="footer-container">
        <div class="footer-text">
            <h3>¿Tienes dudas?</h3>
            <p>Si tienes más preguntas o dudas sobre cualquier tema, puedes contactarnos y seguro te responderemos.</p>
        </div>
        <div class="footer-buttons">
            <a href="mailto:serenamente@iztacala.unam.mx" class="footer-btn">Correo electrónico</a>
            <a href="avisoprivacidad.html" class="footer-btn">Aviso de Privacidad</a>
        </div>
    </div>
</footer>

<script>
    // Funcion para el menu de hamburguesa
    const menuToggle = document.querySelector('.menu-toggle');
    const submenu = document.querySelector('.submenu');

    menuToggle.addEventListener('click', () => {
        submenu.classList.toggle('active'); // Alterna la clase 'active' para mostrar/ocultar el menú
    });

    // Funcion que verifica el token y si se contesto el pretest
    async function verificarAutenticacion() {
        const token = localStorage.getItem("token");
        if (!token) {
            window.location.href = "/TT/login.html";
            return;
        }

        try {
            const response = await fetch("https://serenamente.iztacala.unam.mx/api/auth/verify-token", {
                method: "GET",
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (!response.ok) {
                console.error("Error en la autenticación:", await response.json());
                localStorage.removeItem("token");
                window.location.href = "/TT/login.html";
                return;
            }

            const userData = await response.json();
            const initials = userData.usuario.nombre
            .split(" ")
            .map(word => word[0])
            .join("")
            .toUpperCase();
            document.getElementById("user-avatar").textContent = initials;
        } catch (error) {
            console.error("Error en la autenticación:", error);
            window.location.href = "/TT/login.html";
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        const avatar = document.getElementById("user-avatar");
        const userMenu = document.querySelector(".user-menu");

        avatar.addEventListener("click", function () {
            userMenu.classList.toggle("active");
        });

        document.getElementById("logout").addEventListener("click", function () {
            localStorage.removeItem("token");
            window.location.href = "/TT/login.html";
    });

    verificarAutenticacion();
    });

    //funcion de botones 
    function startExperience() {
        document.getElementById('activities-menu').classList.remove('hidden');
        document.querySelector('.button-container').classList.add('hidden');
    }
        function postponeExperience() {
            alert('Puedes volver cuando estés listo');
            document.querySelector('.button-container').classList.add('hidden');
        }

        function startExperience() {
            document.getElementById('activities-menu').style.display = 'flex';
            document.querySelector('.button-container').style.display = 'none';
    }

    // Funcionalidad para extraer el id del token 
    function getTokenId() {
        const token = localStorage.getItem("token");
        if (token) {
            try {
                const base64Url = token.split('.')[1]; // obtiene la parte de carga del JWT
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));

                const { id } = JSON.parse(jsonPayload);
                return id;
            } catch (error) {
                console.error("Error decoding token:", error);
                return null;
            }
        }
        return null;
    }

    // Lógica principal: desbloquea SOLO la actividad actual
    document.addEventListener("DOMContentLoaded", async function () {
        const token = localStorage.getItem("token");
        if (!token) {
            window.location.href = "/TT/login.html";
            return;
        }

        const paciente_id = getTokenId();

        // Obtener tratamiento actual del paciente
        const tratamientoResponse = await fetch(`https://serenamente.iztacala.unam.mx/api/tratamiento/buscar_protocolo/${paciente_id}`);
        const tratamientoData = await tratamientoResponse.json();
        const tratamiento_id = tratamientoData.ID_Tratamiento;

        // ID de la habilidad (puede estar fijo o dinámico según el contexto)
        const habilidad_id = 6;

        // Obtener actividades relacionadas con la habilidad
        const actividadesResponse = await fetch(`https://serenamente.iztacala.unam.mx/api/tratamiento/ruta_actividad/${tratamiento_id}/habilidad/${habilidad_id}`);
        const actividades = await actividadesResponse.json();
        
        // Obtener la actividad actual del paciente
        const progresoResponse = await fetch(`https://serenamente.iztacala.unam.mx/api/tratamiento/progreso/actividad_actual/${paciente_id}`);
        const progresoData = await progresoResponse.json();
        const actividadActualId = progresoData.id_actividad_actual;

        // Limpiar y mostrar actividades
        const activitiesContainer = document.querySelector(".activities");
        activitiesContainer.innerHTML = "";

        actividades.forEach((actividad, index) => {
            const activityDiv = document.createElement("div");
            activityDiv.classList.add("activity");

            const cardDiv = document.createElement("div");
            cardDiv.classList.add("activity-card");
            cardDiv.id = `activity${index + 1}`;

            const estaDesbloqueada = actividad.ID_Actividad === actividadActualId;

            if (actividad.ID_Actividad < actividadActualId) {
                // Actividad completada – verde
                cardDiv.classList.add("completada");
            } else if (actividad.ID_Actividad === actividadActualId) {
                // Actividad actual – desbloqueada
                // No hacemos nada, se queda normal
            } else {
                // Actividad futura – bloqueada
                cardDiv.classList.add("disabled");
            }

            cardDiv.innerHTML = `
                <p>${index + 1}. ${actividad.Nombre}</p>
                <a href="actividad${actividad.ID_Actividad}.html">
                    <button ${actividad.ID_Actividad > actividadActualId ? "disabled" : ""}>
                        <img src="static/imagenes/boton${habilidad_id}${index + 1}.png" alt="actividad${habilidad_id}${index + 1}">
                    </button>
                </a>
            `;

            activityDiv.appendChild(cardDiv);
            activitiesContainer.appendChild(activityDiv);
        });
    });

    // Funcionalidad del minijuego del memorama
   const pares = [
    { id: 1, tipo: 'texto', contenido: 'Responder vs. Reaccionar' },
    { id: 1, tipo: 'imagen', contenido: 'static/imagenes/memo1.jpeg' },
    { id: 2, tipo: 'texto', contenido: 'Las "Firmas" del Estrés' },
    { id: 2, tipo: 'imagen', contenido: 'static/imagenes/memo2.jpeg' },
    { id: 3, tipo: 'texto', contenido: 'Tolerancia al Malestar' },
    { id: 3, tipo: 'imagen', contenido: 'static/imagenes/memo3.jpeg' },
    { id: 4, tipo: 'texto', contenido: 'Conciencia Interpersonal (Mindfulness Interpersonal)' },
    { id: 4, tipo: 'imagen', contenido: 'static/imagenes/memo4.jpeg' },
    { id: 5, tipo: 'texto', contenido: 'Comunicación Consciente' },
    { id: 5, tipo: 'imagen', contenido: 'static/imagenes/memo5.jpeg' },
    { id: 6, tipo: 'texto', contenido: 'Neuroplasticidad' },
    { id: 6, tipo: 'imagen', contenido: 'static/imagenes/memo6.jpeg' }
    ];

    const cards = [...pares].sort(() => 0.5 - Math.random());
    const gameBoard = document.getElementById('gameBoard');
    const winMessage = document.getElementById('winMessage');
    let flippedCards = [];
    let lockBoard = false;

    cards.forEach(cardData => {
    const card = document.createElement('div');
    card.classList.add('card');
    card.dataset.id = cardData.id;
    card.dataset.tipo = cardData.tipo;

    const cardInner = document.createElement('div');
    cardInner.classList.add('card-inner');

    const front = document.createElement('div');
    front.classList.add('card-front');

    if (cardData.tipo === 'imagen') {
        const img = document.createElement('img');
        img.src = cardData.contenido;
        img.alt = 'Imagen';
        front.appendChild(img);
    } else {
        front.textContent = cardData.contenido;
    }

    const back = document.createElement('div');
    back.classList.add('card-back');
    back.textContent = '?';

    cardInner.appendChild(front);
    cardInner.appendChild(back);
    card.appendChild(cardInner);
    gameBoard.appendChild(card);

    card.addEventListener('click', () => flipCard(card));
    });

    function flipCard(card) {
    if (lockBoard || card.classList.contains('flipped')) return;

    card.classList.add('flipped');
    flippedCards.push(card);

    if (flippedCards.length === 2) {
        lockBoard = true;
        const [card1, card2] = flippedCards;

        if (
        card1.dataset.id === card2.dataset.id &&
        card1.dataset.tipo !== card2.dataset.tipo
        ) {
        flippedCards = [];
        lockBoard = false;
        checkWin();
        } else {
        setTimeout(() => {
            card1.classList.remove('flipped');
            card2.classList.remove('flipped');
            flippedCards = [];
            lockBoard = false;
        }, 1000);
        }
    }
    }

    function checkWin() {
    const allCards = document.querySelectorAll('.card');
    const flipped = document.querySelectorAll('.card.flipped');
    if (flipped.length === allCards.length) {
        winMessage.style.display = 'block';
    }
    }
</script>
</body>
</html>
