<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habilidad 6: Cuidarte es volver a ti</title>
    <link rel="stylesheet" href="static/styles/habilidad.css">
</head>

<header>
    <div class="header-container">
        <div class="logo-container">
            <a href="index.html">
                <img src="static/imagenes/logo.jpeg" alt="Logo SerenaMente IA" class="logo">
            </a>
        </div>
        <button class="menu-toggle" aria-label="Toggle Menu">&#9776;</button>
        <nav class="submenu">
            <ul>
                <li><a href="actividades.html">Mis actividades</a></li>
                <li><a href="progreso.html">Mi progreso</a></li>
                <div class="user-menu">
                    <div id="user-avatar" class="avatar">US</div>
                    <div id="user-dropdown" class="dropdown-menu">
                        <a href="perfil.html">Ver perfil</a>
                        <a href="#" id="logout">Cerrar sesión</a>
                    </div>
                </div>                        
            </ul>
        </nav>
    </div>
</header>


<main>
    <div class="container">
        <h1>Habilidad 6: Cuidarte es volver a ti</h1>
            <div style="display: flex; align-items: flex-start; gap: 20px;">
                <img src="static/imagenes/image7.jpg" alt="Descripción de la imagen" style="height: 100%; max-height: 300px; width: auto; object-fit: cover;">
                <div style="flex: 1;">
                    <p> ¡Hola! ¡Te doy la bienvenida a la última habilidad que
                        entrenaremos! Hoy llegamos a un momento especial del camino en SerenaMente IA, integrar tus experiencias y reconocer que el cuidado y bienestar
                        comienza en tu interior!
                        <br>
                       <strong>Objetivo:</strong> En esta última habilidad conectarás lo que has vivenciado hasta ahora y cómo lo has integrado a tu vida desarrollando y fortaleciendo tus recursos internos
                        y externos de manera que te conviertas en refugio propio, donde habites sereno y presente.
                        <br>
                        A lo largo de cada habilidad te has encontrado contigo en distintas formas. Piensa en los momentos del programa en que sentiste conexión contigo, ¿qué
                        práctica te funcionó mejor?, ¿qué señales te envías cuando necesitas una pausa?, ¿qué descubriste sobre tus formas de responder al estrés?, ¿ha cambiado tu
                        forma de comunicarte con los demás cuando estás verdaderamente presente?

                        </p> 
                    <div class="recuerda-box">
                        <img src="static/imagenes/recuerda.jpeg" alt="Koala recuerda" class="koala-img">
                        <p><strong>Recuerda:</strong> esta habilidad no es un cierre, sino el reconocimiento a tu dedicación y ha llegado el momento que tomes consciencia que cuidar de
                            ti mismo es una práctica, ¡cuidar de ti es el pilar del bienestar a largo plazo!
                            </p>
                    </div>
                </div>
            </div>
    <p>Te invito a que revisemos la siguiente presentación que profundiza en el autocuidado
    </p>

        <div class="video-container">
            <div style="position: relative; width: 100%; height: 0; padding-top: 56.2500%;
                padding-bottom: 0; box-shadow: 0 2px 8px 0 rgba(63,69,81,0.16); margin-top: 1.6em; margin-bottom: 0.9em; overflow: hidden;
                border-radius: 8px; will-change: transform;">
                <iframe loading="lazy" style="position: absolute; width: 100%; height: 100%; top: 0; left: 0; border: none; padding: 0;margin: 0;"
                    src="https://www.canva.com/design/DAGmix3HDMk/eFFto--2gYOpIhcfA35HHg/view?embed" allowfullscreen="allowfullscreen" allow="fullscreen">
                </iframe>
                </div>
                <a href="https:&#x2F;&#x2F;www.canva.com&#x2F;design&#x2F;DAGmix3HDMk&#x2F;eFFto--2gYOpIhcfA35HHg&#x2F;view?utm_content=DAGmix3HDMk&amp;utm_campaign=designshare&amp;utm_medium=embeds&amp;utm_source=link" target="_blank" rel="noopener">Autocuidado_H1</a> de Proyecto Serenamente
            <p>Ahora que eres consciente de este camino de bienestar cuidando de ti. Ahora sabes que estás presente en el cuerpo, en
                la emociones, en tus creencias e ideas, también te has encontrado a ti mismo en el encuentro con los demás y que tu respiración te permite acceder a tu
                centro, ¡así es, a ser mindful!, vamos a explorar como puedes mantenerlo a largo plazo
                
            </p>
        </div>

            <div class="button-container">
                <button onclick="startExperience()">Sí, tengo todo preparado para iniciar</button>
                <button onclick="postponeExperience()">No, quisiera empezar después</button>
            </div>
            
            <div id="activities-menu">
                <div class="serenito">
                    <div class="speech-bubble">Selecciona la actividad para comenzar</div>
                    <img src="static/imagenes/serenito.png" alt="Serenito">
                </div>
                <div class="activities">
                    <!-- Actividad 1  -->
                    <div class="activity">
                        <div class="activity-card" id="activity1" onclick="unlockActivity(2)">
                            <p>1. Actividades que Nutren</p>
                            <a href="actividad61.html">
                                <button> 
                                    <img src="static/imagenes/boton61.png" alt="Actividad 1">
                                </button>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Actividad 2 -->
                    <div class="activity">
                        <div class="activity-card disabled" id="activity2" onclick="unlockActivity(3)">
                            <p>2. Presencia Sostenida en la Vida Real </p>
                            <a href="actividad62.html">
                                <button disabled>
                                    <img src="static/imagenes/boton62.png" alt="Actividad 2">
                                </button>
                            </a>
                        </div>
                    </div>
            
                    <!-- Actividad 3  -->
                    <div class="activity">
                        <div class="activity-card disabled" id="activity3"onclick="unlockActivity(4)">
                            <p>3. . Respiración Consciente </p>
                            <a href="actividad63.html">
                                <button disabled>
                                    <img src="static/imagenes/boton63.png" alt="Actividad 3">
                                </button>
                            </a>
                        </div>
                    </div>
                    <!-- Actividad 4 -->
                    <div class="activity">
                        <div class="activity-card disabled" id="activity4">
                            <p>4. Meditación de la Montaña</p>
                            <a href="actividad64.html">
                                <button disabled>
                                    <img src="static/imagenes/boton64.png" alt="Actividad 4">
                                </button>
                            </a>
                        </div>
                    </div>
        </div>
    </div>
</main>
<div class="social-bar">
    <a href="https://www.facebook.com/SerenaMenteUNAM?_rdc=1&_rdr#" target="_blank" class="social-icon">
        <img src="static/imagenes/Logo_facebook.png" alt="Facebook">
    </a>
    <a href="https://www.instagram.com/serenamente_app/?igshid=YTQwZjQ0NmI0OA%3D%3D" target="_blank" class="social-icon">
        <img src="static/imagenes/Logo_instagram.png" alt="Instagram">
    </a>
    <a href="https://www.youtube.com/@SerenaMente-xk7tm" target="_blank" class="social-icon">
        <img src="static/imagenes/Logo_youtube.png" alt="YouTube">
    </a>

</div>

<!--Banner con logos-->
<div class="banner-section">
    <div class="banner-logo">
        <img src="static/imagenes/LOGO.png" alt="Logo SerenaMente">
    </div>
    <div class="banner-text">
        <p>Cuenta con el respaldo y colaboración de investigadores e investigadoras de las siguientes instituciones.</p>
    </div>
    <div class="banner-logos">
        <a href="https://www.unam.mx">
            <img src="static/imagenes/Logo1.png" alt="Logo UNAM">
        </a>
        <a href="https://suayed.iztacala.unam.mx/">
            <img src="static/imagenes/Logo2.png" alt="Logo SUAYED">
        </a>
        <a href="https://labpsiit.iztacala.unam.mx/">
            <img src="static/imagenes/Logo3.png" alt="Logo LABPSITT">
        </a>
        <a href="https://www.ipn.mx/">
            <img src="static/imagenes/Logo4.png" alt="Logo IPN">
        </a>
        <a href="https://www.escom.ipn.mx/">
            <img src="static/imagenes/Logo5.png" alt="Logo ESCOM">
        </a>
    </div>
</div>

<!-- Footer -->
<footer>
    <div class="footer-container">
        <div class="footer-text">
            <h3>¿Tienes dudas?</h3>
            <p>Si tienes más preguntas o dudas sobre cualquier tema, puedes contactarnos y seguro te responderemos.</p>
        </div>
        <div class="footer-buttons">
            <a href="mailto:serenamente@iztacala.unam.mx" class="footer-btn">Correo electrónico</a>
            <a href="avisoprivacidad.html" class="footer-btn">Aviso de Privacidad</a>
        </div>
    </div>
</footer>

<script>
    // Funcion para el menu de hamburguesa
    const menuToggle = document.querySelector('.menu-toggle');
    const submenu = document.querySelector('.submenu');

    menuToggle.addEventListener('click', () => {
        submenu.classList.toggle('active'); // Alterna la clase 'active' para mostrar/ocultar el menú
    });

    // Funcion que verifica el token y si se contesto el pretest
    async function verificarAutenticacion() {
        const token = localStorage.getItem("token");
        if (!token) {
            window.location.href = "login.html";
            return;
        }

        try {
            const response = await fetch("https://serenamente.iztacala.unam.mx/api:8002/auth/verify-token", {
                method: "GET",
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (!response.ok) {
                console.error("Error en la autenticación:", await response.json());
                localStorage.removeItem("token");
                window.location.href = "login.html";
                return;
            }

            const userData = await response.json();
            const initials = userData.usuario.nombre
            .split(" ")
            .map(word => word[0])
            .join("")
            .toUpperCase();
            document.getElementById("user-avatar").textContent = initials;
        } catch (error) {
            console.error("Error en la autenticación:", error);
            window.location.href = "login.html";
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        const avatar = document.getElementById("user-avatar");
        const userMenu = document.querySelector(".user-menu");

        avatar.addEventListener("click", function () {
            userMenu.classList.toggle("active");
        });

        document.getElementById("logout").addEventListener("click", function () {
            localStorage.removeItem("token");
            window.location.href = "login.html";
    });

    verificarAutenticacion();
    });

    //funcion de botones 
    function startExperience() {
        document.getElementById('activities-menu').classList.remove('hidden');
        document.querySelector('.button-container').classList.add('hidden');
    }
        function postponeExperience() {
            alert('Puedes volver cuando estés listo');
            document.querySelector('.button-container').classList.add('hidden');
        }

        function startExperience() {
            document.getElementById('activities-menu').style.display = 'flex';
            document.querySelector('.button-container').style.display = 'none';
    }

    // Funcionalidad para extraer el id del token 
    function getTokenId() {
        const token = localStorage.getItem("token");
        if (token) {
            try {
                const base64Url = token.split('.')[1]; // obtiene la parte de carga del JWT
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));

                const { id } = JSON.parse(jsonPayload);
                return id;
            } catch (error) {
                console.error("Error decoding token:", error);
                return null;
            }
        }
        return null;
    }

    // Lógica principal: desbloquea SOLO la actividad actual
    document.addEventListener("DOMContentLoaded", async function () {
        const token = localStorage.getItem("token");
        if (!token) {
            window.location.href = "login.html";
            return;
        }

        const paciente_id = getTokenId();

        // Obtener tratamiento actual del paciente
        const tratamientoResponse = await fetch(`https://serenamente.iztacala.unam.mx/api:8002/tratamiento/buscar_protocolo/${paciente_id}`);
        const tratamientoData = await tratamientoResponse.json();
        const tratamiento_id = tratamientoData.ID_Tratamiento;

        // ID de la habilidad (puede estar fijo o dinámico según el contexto)
        const habilidad_id = 7;

        // Obtener actividades relacionadas con la habilidad
        const actividadesResponse = await fetch(`https://serenamente.iztacala.unam.mx/api:8002/tratamiento/ruta_actividad/${tratamiento_id}/habilidad/${habilidad_id}`);
        const actividades = await actividadesResponse.json();
        
        // Obtener la actividad actual del paciente
        const progresoResponse = await fetch(`https://serenamente.iztacala.unam.mx/api:8002/tratamiento/progreso/actividad_actual/${paciente_id}`);
        const progresoData = await progresoResponse.json();
        const actividadActualId = progresoData.id_actividad_actual;

        // Limpiar y mostrar actividades
        const activitiesContainer = document.querySelector(".activities");
        activitiesContainer.innerHTML = "";

        actividades.forEach((actividad, index) => {
            const activityDiv = document.createElement("div");
            activityDiv.classList.add("activity");

            const cardDiv = document.createElement("div");
            cardDiv.classList.add("activity-card");
            cardDiv.id = `activity${index + 1}`;

            const estaDesbloqueada = actividad.ID_Actividad === actividadActualId;

            if (actividad.ID_Actividad < actividadActualId) {
                // Actividad completada – verde
                cardDiv.classList.add("completada");
            } else if (actividad.ID_Actividad === actividadActualId) {
                // Actividad actual – desbloqueada
                // No hacemos nada, se queda normal
            } else {
                // Actividad futura – bloqueada
                cardDiv.classList.add("disabled");
            }

            cardDiv.innerHTML = `
                <p>${index + 1}. ${actividad.Nombre}</p>
                <a href="actividad${actividad.ID_Actividad}.html">
                    <button ${actividad.ID_Actividad > actividadActualId ? "disabled" : ""}>
                        <img src="static/imagenes/boton${habilidad_id}${index + 1}.png" alt="actividad${habilidad_id}${index + 1}">
                    </button>
                </a>
            `;

            activityDiv.appendChild(cardDiv);
            activitiesContainer.appendChild(activityDiv);
        });
    });

    // Funcionalidad del minijuego del memorama 
    const pares = [
    { id: 1, tipo: 'texto', contenido: 'ft1' },
    { id: 1, tipo: 'imagen', contenido: 'Imagenes5/ft1.png' },
    { id: 2, tipo: 'texto', contenido: 'ft2' },
    { id: 2, tipo: 'imagen', contenido: 'Imagenes5/ft2.png' },
    { id: 3, tipo: 'texto', contenido: 'ft3' },
    { id: 3, tipo: 'imagen', contenido: 'Imagenes5/ft3.png' },
    { id: 4, tipo: 'texto', contenido: 'ft4' },
    { id: 4, tipo: 'imagen', contenido: 'Imagenes5/ft4.png' },
    { id: 5, tipo: 'texto', contenido: 'ft5' },
    { id: 5, tipo: 'imagen', contenido: 'Imagenes5/ft5.png' },
    { id: 6, tipo: 'texto', contenido: 'ft6' },
    { id: 6, tipo: 'imagen', contenido: 'Imagenes5/ft6.png' }
    ];

    const cards = [...pares].sort(() => 0.5 - Math.random());
    const gameBoard = document.getElementById('gameBoard');
    const winMessage = document.getElementById('winMessage');
    let flippedCards = [];
    let lockBoard = false;

    cards.forEach(cardData => {
    const card = document.createElement('div');
    card.classList.add('card');
    card.dataset.id = cardData.id;
    card.dataset.tipo = cardData.tipo;

    const cardInner = document.createElement('div');
    cardInner.classList.add('card-inner');

    const front = document.createElement('div');
    front.classList.add('card-front');

    if (cardData.tipo === 'imagen') {
        const img = document.createElement('img');
        img.src = cardData.contenido;
        img.alt = 'Imagen';
        front.appendChild(img);
    } else {
        front.textContent = cardData.contenido;
    }

    const back = document.createElement('div');
    back.classList.add('card-back');
    back.textContent = '?';

    cardInner.appendChild(front);
    cardInner.appendChild(back);
    card.appendChild(cardInner);
    gameBoard.appendChild(card);

    card.addEventListener('click', () => flipCard(card));
    });

    function flipCard(card) {
    if (lockBoard || card.classList.contains('flipped')) return;

    card.classList.add('flipped');
    flippedCards.push(card);

    if (flippedCards.length === 2) {
        lockBoard = true;
        const [card1, card2] = flippedCards;

        if (
        card1.dataset.id === card2.dataset.id &&
        card1.dataset.tipo !== card2.dataset.tipo
        ) {
        flippedCards = [];
        lockBoard = false;
        checkWin();
        } else {
        setTimeout(() => {
            card1.classList.remove('flipped');
            card2.classList.remove('flipped');
            flippedCards = [];
            lockBoard = false;
        }, 1000);
        }
    }
    }

    function checkWin() {
    const allCards = document.querySelectorAll('.card');
    const flipped = document.querySelectorAll('.card.flipped');
    if (flipped.length === allCards.length) {
        winMessage.style.display = 'block';
    }
    }
</script>
</body>
</html>
