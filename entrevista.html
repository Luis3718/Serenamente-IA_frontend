<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SerenaMente IA</title>
    <link rel="stylesheet" href="static/styles/entrevista.css">
</head>
<body>
    <!-- Submenú y logo-->
    <header>
        <div class="header-container">
            <div class="logo-container">
                <a href="index.html">
                    <img src="static/imagenes/logo.jpg" alt="Logo SerenaMente IA" class="logo">
                </a>
            </div>
            <button class="menu-toggle" aria-label="Toggle Menu">
                &#9776; <!-- Icono de tres rayitas -->
            </button>
            <nav class="submenu">
                <ul>
                    <li><a href="detalles.html">¿Qué es SerenaMente IA?</a></li>
                    <li><a href="quienessomos.html">¿Quiénes Somos?</a></li>
                    <li><a href="FAQS.html">FAQ's</a></li>
                    <li><a href="#" id="logout">Cerrar sesión</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Contenido principal -->
    <main>
        <div class="container">
            <div class="chatbot-container">
                <div class="chatbot-header">Entrevista SerenaMente</div>
                <div class="chatbot-messages" id="mensajes-de-chat"></div>
                <div class="chatbot-input">
                    <div id="opciones-contenedor" class="opciones-contenedor"></div>
                    <button class="boton-enviar" id="boton-enviar">Enviar</button>
                </div>
            </div>
            <div class="mascota-container">
                <img src="static/imagenes/mascota.jpg" alt="Mascota de SerenaMente" class="mascota-imagen">
            </div>
        </div>        
    </main>
    
    <div class="social-bar">
        <a href="https://www.facebook.com/SerenaMenteUNAM?_rdc=1&_rdr#" target="_blank" class="social-icon">
            <img src="static/imagenes/Logo_facebook.png" alt="Facebook">
        </a>
        <a href="https://www.instagram.com/serenamente_app/?igshid=YTQwZjQ0NmI0OA%3D%3D" target="_blank" class="social-icon">
            <img src="static/imagenes/Logo_instagram.png" alt="Instagram">
        </a>
        <a href="https://www.youtube.com/@SerenaMente-xk7tm" target="_blank" class="social-icon">
            <img src="static/imagenes/Logo_youtube.png" alt="YouTube">
        </a>
    </div>
    
    <!--Banner con logos-->
    <div class="banner-section">
        <div class="banner-logo">
            <img src="static/imagenes/LOGO.png" alt="Logo SerenaMente">
        </div>
        <div class="banner-text">
            <p>Cuenta con el respaldo y colaboración de investigadores e investigadoras de las siguientes instituciones.</p>
        </div>
        <div class="banner-logos">
            <a href="https://www.unam.mx">
                <img src="static/imagenes/Logo1.png" alt="Logo UNAM">
            </a>
            <a href="https://suayed.iztacala.unam.mx/">
                <img src="static/imagenes/Logo2.png" alt="Logo SUAYED">
            </a>
            <a href="https://labpsiit.iztacala.unam.mx/">
                <img src="static/imagenes/Logo3.png" alt="Logo LABPSITT">
            </a>
            <a href="https://www.ipn.mx/">
                <img src="static/imagenes/Logo4.png" alt="Logo IPN">
            </a>
            <a href="https://www.escom.ipn.mx/">
                <img src="static/imagenes/Logo5.png" alt="Logo ESCOM">
            </a>
        </div>
    </div>
    
    <!-- Footer -->
    <footer>
        <div class="footer-container">
            <div class="footer-text">
                <h3>¿Tienes dudas?</h3>
                <p>Si tienes más preguntas o dudas sobre cualquier tema, puedes contactarnos y seguro te responderemos.</p>
            </div>
            <div class="footer-buttons">
                <a href="mailto:serenamente@iztacala.unam.mx" class="footer-btn">Correo electrónico</a>
                <a href="avisoprivacidad.html" class="footer-btn">Aviso de Privacidad</a>
            </div>
        </div>
    </footer>
    
</body>
<script>
    // Funcion para el menu de hamburguesa
    const menuToggle = document.querySelector('.menu-toggle');
    const submenu = document.querySelector('.submenu');

    menuToggle.addEventListener('click', () => {
        submenu.classList.toggle('active'); // Alterna la clase 'active' para mostrar/ocultar el menú
    });

    // Funcion para dar funcionalidad al logout
    document.getElementById("logout").addEventListener("click", function () {
        localStorage.removeItem("token");
        window.location.href = "login.html";
    });

    // Funcion que verifica el token y si se contesto el pretest
    async function verificarAutenticacion() {
        const token = localStorage.getItem("token");
        if (!token) {
            window.location.href = "login.html";
            return;
        }

        try {
            const response = await fetch("http://localhost:8002/auth/verify-token", {
                method: "GET",
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (!response.ok) {
                console.error("Error en la autenticación:", await response.json());
                localStorage.removeItem("token");
                window.location.href = "login.html";
                return;
            }

            console.log("No hay error con el token")
        } catch (error) {
            console.error("Error en la autenticación:", error);
            window.location.href = "login.html";
        }
    }

    // Funcionalidad para extraer el id del token 
    function getTokenId() {
    const token = localStorage.getItem("token");
    if (token) {
        try {
            const base64Url = token.split('.')[1]; // obtiene la parte de carga del JWT
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            const { id } = JSON.parse(jsonPayload);
            return id;
        } catch (error) {
            console.error("Error decoding token:", error);
            return null;
        }
    }
    return null;
    }

    document.addEventListener('DOMContentLoaded', function() {
        const messagesContainer = document.getElementById("mensajes-de-chat");
        const optionsContainer = document.getElementById("opciones-contenedor");
        const sendButton = document.getElementById("boton-enviar");
    
        let preguntaActual = 0;
        const responses = []; // Arreglo para guardar las respuestas
    
        const preguntas = [
            { text: "¡Hola! Soy tu asistente Serenito y te doy la bienvenida a SerenaMente IA. Nuestro objetivo es ayudar a mejorar tu bienestar a través del mindfulness. Antes de comenzar quisiera preguntarte algunas cosas, te pido que contestes de manera honesta para poder identificar tus características y necesidades para diseñar un plan a tu medida. Ten en cuenta que no hay respuestas correctas o incorrectas, y que estas preguntas no afectarán tu evaluación. ¿Te parece si comenzamos?", opciones: ["Sí", "No"] },
            { text: "Me gustaría saber si has estado en terapia psicológica antes?", opciones: ["Sí", "No"], 
                subpreguntas: [
                    { 
                        text: "¿Hace cuánto fue esa terapia, en meses?",
                        opciones: [],
                        respuestaDefault: "No aplica"
                    }
                ]
            },
            { text: "¿Cuánto tiempo consideras que dedicas a la semana  a tu salud emocional (talleres, podcast, asesorías, etc)?", opciones: [] },
            { text: "¿Cuánto tiempo dedicas a la semana a realizar actividades físicas (deportes como correr, nadar, pesas, o a través de caminar, correr o baile, etc?)", opciones: [] },
            { text: "¿Cuánto tiempo dedicas a la semana a tu la convivencia con tu red social (encontrarte con vecinos, amistades, familiares, o en clubes de pasatiempos, grupos deportivos o culturales, etc?)", opciones: [] },
            { text: "¿Sabes en qué consiste el concepto mindfulness?", opciones: ["Sí", "No"],
                subpreguntas: [
                    {
                        text: "¿Has practicado mindfulness?",
                        opciones: ["Sí lo he practicado", "Si, actualmente lo practico", "Nunca lo he practicado"],
                        respuestaDefault: "No aplica",

                        subpreguntas: [
                            {
                                text: "¿Cuántas horas a la semana?",
                                opciones: [],
                                respuestaDefault: "No aplica"
                            },
                            {
                                text: "¿En qué nivel de practicante te identificas?",
                                opciones: ["Principiante", "Medio", "Avanzado"],
                                respuestaDefault: "No aplica"
                            }
                        ]
                    }
                ]
            },
            { text: "Un elemento fundamental para que las actividades de mindfulness tengan un impacto positivo en la vida es la constancia diaria de las prácticas, nos gustaría enviarte recordatorios para realizar tus prácticas. ¿En qué horario quieres que te envíe un recordatorio para hacer tus prácticas de SerenaMente IA?", opciones: ["AM", "PM"] },
            { text: "¿Qué dificultades crees que puede haber en tu práctica de mindfulness?", opciones: ["Dispongo de poco tiempo", "Nunca la he practicado", "Tengo dudas si lo lograré", "Se me dificulta no moverme", "Se me dificulta estar en silencio", "Se me dificulta dejar de pensar en mis preocupaciones", "Se me dificulta sostener mi atención por mucho tiempo", "No creo que pueda incorporar en mi vida cotidiana", "Siento que debe llevar mucho tiempo aprenderla", "Siento que me voy a aburrir", "Suelo muchas cosas iniciadas sin concluir", "Otros aspectos"] },
            { text: "¿Qué te gustaría lograr o mejorar con la práctica de mindfulness?", opciones: ["Gestionar mi estrés", "Aumentar mi autoconfianza", "Lidiar con una situación difícil", "Aceptar mi realidad", "Disminuir mi estado de ansiedad", "Regular las emociones que me incomodan", "Tolerar la frustración y el enojo", "Aumentar mi concentración y ser más eficiente en mis actividades", "Incrementar mi gratitud y compasión", "Compartirlo con mis seres queridos", "Cultivar la paciencia y la serenidad", "Terminar lo que comienzo"] }
        ];
    
        function addMessage(content, isUser) {
            const messageElement = document.createElement("div");
            messageElement.classList.add(isUser ? "mensaje-usuario" : "mensaje-bot");
            messageElement.textContent = content;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function typeMessage(text, isUser, callback) {
            const messageElement = document.createElement("div");
            messageElement.classList.add(isUser ? "mensaje-usuario" : "mensaje-bot");
            messagesContainer.appendChild(messageElement);

            let i = 0;
            const typingInterval = setInterval(() => {
                if (i < text.length) {
                    messageElement.textContent += text.charAt(i);
                    i++;
                } else {
                    clearInterval(typingInterval);
                    messageElement.style.borderRight = 'none';
                    if (callback) callback(); // Asegurar que el callback se llama siempre
                }
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 50);
        }

        function showOptions() {
            optionsContainer.innerHTML = "";

            if (preguntaActual < preguntas.length) {
                const currentQuestion = preguntas[preguntaActual];
                typeMessage(currentQuestion.text, false, () => {
                    if (currentQuestion.opciones.length === 0) { // No hay opciones predefinidas
                        const input = document.createElement("input");
                        input.type = "number"; // Asegura que sólo se puedan ingresar números
                        input.name = "respuesta-numerica";
                        input.placeholder = "Ingresa tu respuesta aquí...";
                        optionsContainer.appendChild(input);
                    } else {
                        currentQuestion.opciones.forEach(opcion => {
                            const etiqueta = document.createElement("label");
                            etiqueta.classList.add("opcion-etiqueta");
                            const entrada = document.createElement("input");
                            entrada.type = "radio";
                            entrada.name = "opcion-de-pregunta";
                            entrada.value = opcion;
                            etiqueta.appendChild(entrada);
                            etiqueta.append(opcion);
                            optionsContainer.appendChild(etiqueta);
                        });
                    }
                    sendButton.disabled = false;
                });
            } else {
                typeMessage("¡Gracias por responder! Vamos a preparar tu plan de mindfulness.", false);
                sendButton.disabled = true;
            }
        }

        sendButton.addEventListener('click', function handleSendClick() {
            let selectedValue;
            if (preguntas[preguntaActual].opciones.length === 0) {
                selectedValue = document.querySelector('input[name="respuesta-numerica"]').value;
            } else {
                const selectedOption = document.querySelector('input[name="opcion-de-pregunta"]:checked');
                selectedValue = selectedOption ? selectedOption.value : '';
            }

            if (selectedValue) {
                addMessage(selectedValue, true);
                responses.push({ pregunta: preguntas[preguntaActual].text, respuesta: selectedValue });

                // Manejo de subpreguntas para subpreguntas
                if (preguntas[preguntaActual].subpreguntas) {
                    if (selectedValue === "Sí" || selectedValue === "Sí lo he practicado" || selectedValue === "Si, actualmente lo practico") {
                        preguntas.splice(preguntaActual + 1, 0, ...preguntas[preguntaActual].subpreguntas);
                    }
                }

                preguntaActual++;
                setTimeout(showOptions, 800);
            } else {
                console.error("No se ha seleccionado ninguna opción o ingresado un valor numérico");
            }
        });
    
        async function marcar_entrevista() {
            const idPaciente = getTokenId();
            if (idPaciente) {
                try {
                    const response = await fetch(`http://localhost:8002/formularios/contestar_entrevista/${idPaciente}`, {
                        method: 'POST'
                    });
                    if (response.ok) {
                        console.log('Entrevista marcada exitosamente');
                        window.location.href = 'dashboard.html'; // Redirigir a la página de dashboard
                    } else {
                        throw new Error('Fallo al marcar la entrevista');
                    }
                } catch (error) {
                    console.error('Error al marcar la entrevista:', error);
                }
            } else {
                console.error('ID del paciente no disponible');
            }
        }

        function enviarRespuestas() {
            const data = {
                ID_Paciente: getTokenId(),
                formType: 11,
                totalScore: 0,
                category: "No aplica",
                responses: responses
            };
    
            fetch('http://localhost:8002/formularios/respuestas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => console.log("Datos enviados exitosamente", data))
            .catch(error => console.error("Error al enviar datos", error));
        }
        
        //verificarAutenticacion();
        showOptions();
    });
</script>    
</html>