<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Administrador · Habilidades</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="static/styles/admin.css">
</head>
<body>
<header>
  <img src="static/imagenes/logo.jpg" alt="Logo Serenamente">
  <nav>
    <ul>
      <li><a href="admin_habilidades.html" class="active">Habilidades</a></li>
      <li><a href="admin_actividades.html">Actividades</a></li>
      <li><a href="admin_paciente.html">Pacientes</a></li>
      <li><a href="#" onclick="cerrarSesion()">Cerrar sesión</a></li>
    </ul>
  </nav>
</header>

<div class="container">
  <h1>Gestión de Habilidades</h1>

  <!-- Formulario de habilidad -->
  <section class="card">
    <h2 id="formTitle">Crear nueva habilidad</h2>
    <input type="hidden" id="habilidadId">
    <input type="text" id="nombre" placeholder="Nombre de la habilidad">
    <button class="btn-success" onclick="guardar()">Guardar</button>
    <button class="btn-secondary" onclick="resetForm()" id="cancelarBtn" hidden>Cancelar</button>
  </section>

  <!-- Tabla de habilidades -->
  <section class="card">
    <h2>Listado de habilidades</h2>
    <input type="text" id="buscar" placeholder="Buscar por nombre..." oninput="dibujar()">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Nombre</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tbodyHabilidades"></tbody>
    </table>
  </section>

  <!-- Tabla de actividades asociadas -->
  <section class="card" id="seccionActividades" hidden>
    <h2>Actividades de la habilidad seleccionada</h2>
    <p id="nombreHabilidadSeleccionada" style="font-weight: bold;"></p>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Actividad</th>
        </tr>
      </thead>
      <tbody id="tbodyActividades"></tbody>
    </table>
  </section>
</div>

<script>
const API = "http://localhost:8002/admin/habilidades";
let habilidades = [];

function authHeader() {
  const token = localStorage.getItem("admin_token");
  return { "Authorization": "Bearer " + token, "Content-Type": "application/json" };
}

function cerrarSesion() {
  localStorage.removeItem("admin_token");
  location.href = "login_admin.html";
}

async function cargar() {
  try {
    const res = await fetch(API, { headers: authHeader() });
    habilidades = await res.json();
    dibujar();
  } catch {
    alert("Error al cargar habilidades");
  }
}

function dibujar() {
  const filtro = document.getElementById("buscar").value.toLowerCase();
  const tbody = document.getElementById("tbodyHabilidades");
  tbody.innerHTML = "";

  habilidades
    .filter(h => h.nombre.toLowerCase().includes(filtro))
    .forEach(h => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${h.id_habilidad}</td>
        <td>${h.nombre}</td>
        <td>
          <button class="btn-editar" onclick='editar(${JSON.stringify(h)})'>✏️</button>
          <button class="btn-danger" onclick="eliminar(${h.id_habilidad})">🗑️</button>
          <button onclick="verActividades(${h.id_habilidad}, '${h.nombre}')">📋 Actividades</button>
        </td>`;
      tbody.appendChild(tr);
    });
}

async function guardar() {
  const id = document.getElementById("habilidadId").value;
  const nombre = document.getElementById("nombre").value.trim();
  if (!nombre) return alert("El nombre es obligatorio");

  const data = JSON.stringify({ nombre });
  const method = id ? "PUT" : "POST";
  const url = id ? `${API}/${id}` : API;

  try {
    const res = await fetch(url, {
      method: method,
      headers: authHeader(),
      body: data
    });
    if (!res.ok) throw new Error();
    await cargar();
    resetForm();
  } catch {
    alert("Error al guardar");
  }
}

function editar(habilidad) {
  document.getElementById("habilidadId").value = habilidad.id_habilidad;
  document.getElementById("nombre").value = habilidad.nombre;
  document.getElementById("formTitle").innerText = "Editar habilidad";
  document.getElementById("cancelarBtn").hidden = false;
}

function resetForm() {
  document.getElementById("habilidadId").value = "";
  document.getElementById("nombre").value = "";
  document.getElementById("formTitle").innerText = "Crear nueva habilidad";
  document.getElementById("cancelarBtn").hidden = true;
  document.getElementById("seccionActividades").hidden = true;
}

async function eliminar(id) {
  if (!confirm("¿Deseas eliminar esta habilidad?")) return;
  try {
    const res = await fetch(`${API}/${id}`, {
      method: "DELETE",
      headers: authHeader()
    });
    if (!res.ok) throw new Error();
    await cargar();
  } catch {
    alert("Error al eliminar");
  }
}

async function verActividades(id_habilidad, nombreHabilidad) {
  try {
    const res = await fetch(`${API}/${id_habilidad}/actividades`, {
      headers: authHeader()
    });
    if (!res.ok) throw new Error();

    const actividades = await res.json();
    const tbody = document.getElementById("tbodyActividades");
    const seccion = document.getElementById("seccionActividades");
    const nombreLabel = document.getElementById("nombreHabilidadSeleccionada");

    nombreLabel.innerText = `Habilidad: ${nombreHabilidad}`;
    tbody.innerHTML = "";

    actividades.forEach(act => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${act.id_actividad}</td><td>${act.nombre}</td>`;
      tbody.appendChild(tr);
    });

    seccion.hidden = false;
  } catch {
    alert("Error al cargar actividades");
  }
}

document.addEventListener("DOMContentLoaded", async () => {
  if (!localStorage.getItem("admin_token")) cerrarSesion();
  await cargar();
});
</script>
</body>
</html>
