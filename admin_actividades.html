<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administrador - Actividades</title>
  <link rel="stylesheet" href="static/styles/admin.css">
</head>
<body>

<header>
  <img src="static/imagenes/logo.jpg" alt="Logo Serenamente">
  <nav>
    <ul>
      <li><a href="admin_habilidades.html">Habilidades</a></li>
      <li><a href="admin_actividades.html">Actividades</a></li>
      <li><a href="admin_paciente.html">Pacientes</a></li>
      <li><a href="#">Cerrar sesión</a></li>
    </ul>
  </nav>
</header>

<div class="container">
  <h1>Administrador de Actividades</h1>

  <div class="formulario">
    <h2>Crear / Editar Actividad</h2>
    <input type="hidden" id="editIndex" />
    <input type="text" id="titulo" placeholder="Título de la actividad">
    <input type="number" id="idHabilidad" placeholder="ID de habilidad">
    <textarea id="descripcion" rows="4" placeholder="Descripción..."></textarea>
    <textarea id="recursos" placeholder="URLs del recurso multimedia (video o imagen) separadas por coma, una por recurso"></textarea>

    <select id="tipoActividad">
      <option value="">Tipo de actividad</option>
      <option value="Practica">Practica</option>
      <option value="Meditacion">Meditacion</option>
    </select>

    <div class="select-con-boton">
      <button class="btn-success" onclick="guardarActividad()">Guardar Actividad</button>
      <button class="btn-warning" onclick="asignarYVolverAHabilidad()">Seleccionar esta actividad</button>
      <button class="btn-secondary" onclick="window.location.href='ad_terapia.html'">Volver sin seleccionar</button>
    </div>
  </div>

  <div class="busqueda">
    <input type="text" id="buscar" placeholder="Buscar actividad por nombre..." oninput="filtrarActividades()">
  </div>

  <div class="tabla-actividades">
    <table>
      <thead>
        <tr>
          <th>id_actividad</th>
          <th>id_habilidad</th>
          <th>titulo</th>
        </tr>
      </thead>
      <tbody id="lista-actividades"></tbody>
    </table>
  </div>
</div>

<script>
  window.actividades = [];

  function cerrarSesion() {
      localStorage.removeItem("admin_token");
      window.location.href = "/TT/login_admin.html";
  }
    
  function guardarActividad() {
    const titulo = document.getElementById('titulo').value.trim();
    const idHabilidad = document.getElementById('idHabilidad').value;
    const descripcion = document.getElementById('descripcion').value.trim();
    const recursosInput = document.getElementById('recursos').value.trim();
    const recursos = recursosInput.split(',').map(r => r.trim()).filter(r => r);
    const tipo = document.getElementById('tipoActividad').value;

    if (!titulo || !descripcion || recursos.length === 0 || !tipo) {
      alert('Por favor completa todos los campos.');
      return;
    }

    const token = localStorage.getItem("admin_token"); 
    
    console.log({
      id_habilidad: parseInt(idHabilidad),
      nombre: titulo,
      descripcion,
      tipo,
      recursos
    });
    const editId = document.getElementById("editIndex").value;

    const url = editId
      ? `https://serenamente.iztacala.unam.mx/api/admin/actualizar_actividad/${editId}`
      : `https://serenamente.iztacala.unam.mx/api/admin/crear_actividad`;

    const method = editId ? "PUT" : "POST";

    fetch(url, {
      method,
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({
        id_habilidad: parseInt(idHabilidad),
        nombre: titulo,
        descripcion,
        tipo,
        recursos
      })
    })

    .catch(error => {
      console.error(error);
      alert("Hubo un error al guardar la actividad.");
    });
  }

  async function cargarActividades() {
    const token = localStorage.getItem("admin_token");
    try {
      const res = await fetch("https://serenamente.iztacala.unam.mx/api/admin/actividades", {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();

      // GUARDAR en variable global
      window.actividades = data.map(a => ({
        id_actividad: a.id_actividad,
        id_habilidad: a.id_habilidad,
        nombre: a.nombre
      }));

      renderizarActividades(window.actividades);
    } catch (err) {
      alert("Error al cargar actividades");
      console.error(err);
    }
  }

  function renderizarActividades(listaActividades) {
    const lista = document.getElementById('lista-actividades');
    lista.innerHTML = '';

    listaActividades.forEach((act, i) => {
      const fila = document.createElement('tr');
      fila.innerHTML = `
        <td>${act.id_actividad}</td>
        <td>${act.id_habilidad}</td>
        <td>${act.nombre}</td>
        <td class="acciones">
          <button class="btn-ver" onclick="verActividad(${i})">🔍</button>
          <button class="btn-editar" onclick="editarActividad(${i})">✏️</button>
          <button class="btn-danger" onclick="eliminarActividad(${i})">🗑️</button>
        </td>
      `;
      lista.appendChild(fila);
    });
  }

  function asignarYVolverAHabilidad() {
    const titulo = document.getElementById('titulo').value.trim();
    if (!titulo) {
      alert('Debes ingresar el título de la actividad para seleccionarla.');
      return;
    }
    const index = localStorage.getItem('indexActividadSeleccionada');
    if (index !== null) {
      localStorage.setItem(`actividad_${index}`, titulo);
      window.location.href = 'ad_terapia.html';
    } else {
      alert('No se ha identificado el campo de actividad al que pertenece.');
    }
  }

  function editarActividad(i) {
  const act = window.actividades[i];
  document.getElementById("titulo").value = act.nombre;
  document.getElementById("idHabilidad").value = act.id_habilidad;
  document.getElementById("editIndex").value = act.id_actividad;
  }


  async function eliminarActividad(i) {
    if (!window.actividades || !window.actividades[i]) {
      alert("No se encontró la actividad.");
      return;
    }

    const actividad = window.actividades[i];
    const token = localStorage.getItem("admin_token");

    if (!confirm("¿Eliminar esta actividad?")) return;

    try {
      const res = await fetch(`https://serenamente.iztacala.unam.mx/api/admin/eliminar_actividad/${actividad.id_actividad}`, {
        method: "DELETE",
        headers: { Authorization: `Bearer ${token}` }
      });

      if (!res.ok) throw new Error("No se pudo eliminar");
      alert("Actividad eliminada");
      await cargarActividades();
    } catch (err) {
      alert("Error al eliminar la actividad");
      console.error(err);
    }
  }

  function filtrarActividades() {
    const termino = document.getElementById('buscar').value.toLowerCase();
    const lista = document.getElementById('lista-actividades');
    lista.innerHTML = '';
    actividades.filter(act => act.titulo.toLowerCase().includes(termino)).forEach((act, i) => {
      const fila = document.createElement('tr');
      fila.innerHTML = `
        <td>${act.titulo}</td>
        <td>${act.descripcion}</td>
        <td>${act.tipo}</td>
        <td><a href="${act.recurso}" target="_blank">Ver recurso</a></td>
        <td class="acciones">
          <button class="btn-ver" onclick="verActividad(${i})">🔍</button>
          <button class="btn-editar" onclick="editarActividad(${i})">✏️</button>
          <button class="btn-danger" onclick="eliminarActividad(${i})">🗑️</button>
        </td>
      `;
      lista.appendChild(fila);
    });
  }

  function verActividad(i) {
    localStorage.setItem('actividadVista', JSON.stringify(actividades[i]));
    window.open('plantilla_act.html', '_blank');
  }

  document.addEventListener("DOMContentLoaded", async () => {
    const token = localStorage.getItem("admin_token");
    if (!token) return window.location.href = "/TT/login_admin.html";

    try {
      const check = await fetch("https://serenamente.iztacala.unam.mx/api/admin/perfil", {
        method: "GET",
        headers: { Authorization: `Bearer ${token}` }
      });

      if (!check.ok) throw new Error("Token inválido");
      await cargarActividades();
    } catch (err) {
      console.error("Sesión inválida:", err);
      localStorage.removeItem("admin_token");
      window.location.href = "/TT/login_admin.html";
    }
  });

</script>

</body>
</html>

